<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - src/web-worker.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>src/web-worker.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">73.33</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">273</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">26.73</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.80</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/* jshint worker:true */
&#039;use strict&#039;;

var worker = self;
// module.exports = worker;
var deps = worker.VFDeps = {};

// require.ensure([&#039;ampersand-state&#039;], function(require) {
// require.ensure([&#039;ampersand-collection&#039;], function(require) {
// require.ensure([&#039;localforage&#039;, &#039;txml&#039;], function(require) {

var localForage = deps.localForage = require(&#039;localforage&#039;);
localForage.config({
  // driver      : localforage.WEBSQL, // Force WebSQL; same as using setDriver()
  name        : &#039;visualFiha&#039;,
  version     : 1.0,
  size        : 4980736, // Size of database, in bytes. WebSQL-only for now.
  storeName   : &#039;keyvaluepairs&#039;, // Should be alphanumeric, with underscores.
  description : &#039;Visual Fiha storage&#039;
});
deps.State = require(&#039;ampersand-state&#039;);
deps.Collection = require(&#039;ampersand-collection&#039;);


var mappings = require(&#039;./mapping/state&#039;);

// var tXML = require(&#039;txml&#039;);
// function loadSVG(url, done) {
//   done = done || function(err, obj) {
//     console.info(&#039;loadSVG&#039;, err ? err.stack : obj);
//   };

//   fetch(url)
//     .then(function(res) {
//       return res.text();
//     })
//     .then(function(string) {
//       var styles = {};

//       try {
//         tXML(string, {
//           filter: function(child) {
//             return child.attributes &amp;&amp; child.attributes.id &amp;&amp; child.attributes.style;
//           }
//         }).forEach(function(node) {
//           styles[node.attributes.id] = node.attributes.style;
//         });
//       }
//       catch (e) {
//         return done(e);
//       }

//       done(null, {
//         source: string,
//         styles: styles
//       });
//     })
//     .catch(done);
// }


// loadSVG(&#039;assets/zeropaper-fat.svg&#039;);


var ScreenState = require(&#039;./screen/state&#039;);
var workerScreen = new ScreenState();



var SignalCollection = require(&#039;./signal/collection&#039;);
var workerSignals = new SignalCollection();
workerSignals.parent = workerScreen;



// function snapshot() {
//   localForage.setItem(&#039;snapshot&#039;, {
//     screen: workerScreen.serialize(),
//     signals: workerSignals.serialize()
//   });//.then(console.info.bind(console), console.error.bind(console));
// }

// setInterval(snapshot, 5000);


function signature(fn) {
  var args = fn.toString().match(&#039;function[^(]*\\(([^)]*)\\)&#039;);
  if (!args || !args[1].trim()) { return []; }
  return args[1].split(&#039;,&#039;).map(function(a){ return a.trim(); });
}

var signatures = {};
function registerCommand(commandName, command) {
  if (arguments.length === 1) {
    if (typeof arguments[0] === &#039;function&#039;) {
      command = arguments[0];
      commandName = command.name;
    }
    else {
      command = commands[arguments[0]];
    }
  }
  else if (typeof command !== &#039;function&#039;) {
    command = commands[commandName];
  }
  signatures[commandName] = signature(command);
}





var screens = {};
var channel = new BroadcastChannel(&#039;spike&#039;);
function broadcastCommand(name, payload) {
  // console.info(&#039;%cworker broadcast command &quot;%s&quot;&#039;, &#039;color:purple&#039;, name);
  channel.postMessage({
    command: name,
    payload: payload
  });
}
channel.addEventListener(&#039;message&#039;, function(evt) {
  var command = evt.data.command;
  if (command !== &#039;register&#039;) return;

  var payload = evt.data.payload;
  if (screens[payload.id]) {
    return;
  }

  screens[payload.id] = payload.id;
  broadcastCommand(&#039;resetLayers&#039;, {
    layers: workerScreen.layers.serialize()
  });
}, false);

var commands = {
  setup: function(state) {
    workerScreen.set(state);

    broadcastCommand(&#039;setup&#039;, {
      state: state
    });
  },
  midi: function(name, value) {
    console.info(&#039;midi event &quot;%s&quot;, %s&#039;, name, value);
  },
  heartbeat: function(frametime, audio) {
    workerScreen.frametime = frametime;
    workerScreen.audioFrequency = audio.frequency;
    workerScreen.audioTimeDomain = audio.timeDomain;

    broadcastCommand(&#039;heartbeat&#039;, {
      frametime: frametime,
      audio: audio
    });
  },

  addMapping: function(info) {
    mappings.add(info);
  },
  updateMapping: function(info) {
    var state = mappings.find(function(mapping) {
      return info.id === mapping.id;
    });
    state.set(info);
  },

  resetSignals: function(signals) {
    workerSignals.reset(signals);
  },
  addSignal: function(signal) {
    workerSignals.add(signal);
  },
  removeSignal: function(signalName) {
    workerSignals.remove(workerSignals.get(signalName));
  },
  updateSignal: function(signal, signalName) {
    workerSignals.get(signalName).set(signal);
  },

  resetLayers: function(layers) {
    broadcastCommand(&#039;resetLayers&#039;, {
      layers: layers
    });
    workerScreen.layers.reset(layers);
  },
  addLayer: function(layer) {
    var collection = workerScreen.layers;
    broadcastCommand(&#039;addLayer&#039;, {
      layer: layer
    });

    collection.add(layer);

    var state = collection.get(layer.name);
    function filter(serialized) {
      var filtered = {};
      var obj = state.changedAttributes();
      Object.keys(obj).forEach(function(key) {
        if (typeof serialized[key] !== &#039;function&#039;) filtered[key] = serialized[key];
      });
      return filtered;
    }

    state.on(&#039;change&#039;, function() {
      broadcastCommand(&#039;updateLayer&#039;, {
        layer: filter(state.serialize()),
        layerName: layer.name
      });
    });

    collection.add(layer);
  },
  removeLayer: function(layerName) {
    var collection = workerScreen.layers;
    broadcastCommand(&#039;removeLayer&#039;, {
      layerName: layerName
    });
    collection.remove(collection.get(layerName));
  },
  updateLayer: function(layer, layerName) {
    var state = workerScreen.layers.get(layerName);
    state.set(layer);
  }
};


Object.keys(commands).forEach(registerCommand);


worker.addEventListener(&#039;message&#039;, function(evt) {
  var eventId = evt.data.eventId;

  var commandName = evt.data.command;
  var command = commands[commandName];

  // console.info(&#039;%cworker recieved command &quot;%s&quot;&#039;, &#039;color:red&#039;, commandName);

  if (typeof command !== &#039;function&#039;) {
    return worker.postMessage({
      type: &#039;error&#039;,
      command: commandName,
      message: &#039;Unknown command &quot;&#039; + commandName + &#039;&quot;&#039;,
      eventId: eventId
    });
  }

  if (!signatures[commandName]) {
    return worker.postMessage({
      type: &#039;result&#039;,
      command: commandName,
      payload: command(evt.data),
      eventId: eventId
    });
  }

  var commandArgs = signatures[commandName].map(function(argName) {
    return evt.data.payload[argName];
  });

  var result = command.apply(worker, commandArgs);
  if (!eventId) return;
  worker.postMessage({
    type: &#039;result&#039;,
    command: commandName,
    payload: result,
    eventId: eventId
  });
}, false);
// });
// });
// });</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
