!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(require,module,exports){"use strict";var ScreenLayerState=require("./../state"),MappableState=require("./../../mappable/state"),CanvasLayerMapState=MappableState.State.extend({derived:{targetModel:{deps:["collection","collection.parent"],fn:function(){return this.collection.parent}},observedModel:{deps:["targetModel","targetModel.collection","targetModel.collection.parent"],fn:function(){return this.targetModel.collection.parent.collection.parent}}}}),CanvasLayer=MappableState.extend({idAttribute:"name",fillCollection:function(){var a=this.mappings,b=Object.keys(this.constructor.prototype._definition).filter(function(a){return["drawFunction","name"].indexOf(a)<0});return b.forEach(function(b){a.get(b)||a.add({targetProperty:b})}),this},session:{duration:["number",!0,1e3]},cache:{},props:{fps:["number",!0,16],weight:["number",!0,0],name:["string",!0,null],active:["boolean",!0,!0],opacity:["number",!0,100],shadowOffsetX:["number",!0,0],shadowOffsetY:["number",!0,0],shadowBlur:["number",!0,0],shadowColor:["string",!0,"rgba(0,0,0,0.5)"],blending:{type:"string",required:!0,"default":"source-over",values:["source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","copy","xor"]},drawFunction:"any"},serialize:function(){var a=MappableState.prototype.serialize.apply(this,arguments),b={},c=this.serializationProps.props||[];c.length&&(b.props={});var d,e=this.constructor.prototype._definition;for(d in a)b[d]=a[d],c.indexOf(d)>-1&&(b.props[d]=e[d]);b.props=e;var f=typeof this.drawFunction;return"function"===f?b.drawFunction=this.drawFunction.toString():"string"===f&&(b.drawFunction=this.drawFunction),b},derived:{frames:{deps:["duration","fps"],fn:function(){return Math.round(this.duration/1e3*this.fps)}},frame:{deps:["frametime","fps"],fn:function(){return Math.round(this.frametime%this.duration/1e3*this.fps)}},direction:{deps:["frametime","duration"],fn:function(){return this.frame<.5*this.frames?1:-1}},frametime:{cache:!1,fn:function(){return this.screenState.frametime}},screenState:{deps:["collection","collection.parent","collection.parent.collection","collection.parent.collection.parent"],fn:function(){return this.collection.parent.collection.parent}},width:{deps:["screenState","screenState.width"],fn:function(){return this.screenState.width||400}},height:{deps:["screenState","screenState.height"],fn:function(){return this.screenState.height||300}},draw:{deps:["drawFunction"],fn:function(){var fn=this.drawFunction;if("string"==typeof fn)try{eval("fn = (function() { return "+this.drawFunction+"; })()")}catch(err){console.warn("draw function error",err)}return("function"==typeof fn?fn:function(){}).bind(this)}}},collections:{mappings:MappableState.Collection.extend({model:function(a,b){var c=new CanvasLayerMapState(a,b);return b.init===!1&&c.initialize(),c}})}}),_CanvasLayersCache={},CanvasLayers=VFDeps.Collection.extend({mainIndex:CanvasLayer.prototype.idAttribute,comparator:"weight",model:function(a,b){var c={props:a.props||{},serializationProps:{props:Object.keys(a.props||{})}},d=_CanvasLayersCache[a.name]||CanvasLayer.extend(c);_CanvasLayersCache[a.name]=d;var e=new d(a,b);return e.on("change:weight",function(){e.collection.sort()}),b.init===!1&&e.initialize(),e}});module.exports=ScreenLayerState.canvas=ScreenLayerState.extend({collections:{canvasLayers:CanvasLayers}})},{"./../../mappable/state":11,"./../state":5}],2:[function(a,b,c){"use strict";var d=a("./../view");b.exports=d.canvas=d.extend({template:"<canvas></canvas>",derived:{offCanvas:{deps:["width","height","el"],fn:function(){var a=document.createElement("canvas");return a.width=this.width,a.height=this.height,a}},ctx:{deps:["offCanvas"],fn:function(){return this.offCanvas.getContext("2d")}},destCtx:{deps:["el","width","height"],fn:function(){return this.el.getContext("2d")}}},remove:function(){return d.prototype.remove.apply(this,arguments)},update:function(a){a=a||{},this.model.frametime=a.frametime||0;var b=this.width=this.parent.el.clientWidth,c=this.height=this.parent.el.clientHeight,d=this.ctx;return d.clearRect(0,0,b,c),this.model.active?(this.model.canvasLayers.filter(function(a){return a.active}).forEach(function(a){d.shadowOffsetX=a.shadowOffsetX,d.shadowOffsetY=a.shadowOffsetY,d.shadowBlur=a.shadowBlur,d.shadowColor=a.shadowColor,d.globalAlpha=a.opacity/100,d.globalCompositeOperation=a.blending,a.draw(d)}),this.destCtx.clearRect(0,0,b,c),this.destCtx.drawImage(this.offCanvas,0,0,b,c,0,0,b,c),this):this},bindings:VFDeps.assign({width:{name:"width",type:"attribute"},height:{name:"height",type:"attribute"}},d.prototype.bindings)})},{"./../view":10}],3:[function(a,b,c){"use strict";var d=a("./../state");b.exports=d.img=d.extend({props:{src:["string",!0,null]},initialize:function(){if(d.prototype.initialize.apply(this,arguments),!this.src)throw new Error("Missing src attribute for img layer")}})},{"./../state":5}],4:[function(a,b,c){"use strict";var d=a("./../view");b.exports=d.img=d.extend({template:"<img />",bindings:VFDeps.assign({width:{name:"width",type:"attribute"},height:{name:"height",type:"attribute"},"model.src":{type:"attribute",name:"src"}},d.prototype.bindings)})},{"./../view":10}],5:[function(a,b,c){"use strict";var d=a("./../mappable/state"),e=d.extend({idAttribute:"name",typeAttribute:"type",props:{active:["boolean",!0,!0],mixBlendMode:{type:"string","default":"normal",required:!0,values:["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color"]},name:["string",!0,null],opacity:{type:"number","default":100},rotateX:{type:"number","default":0},rotateY:{type:"number","default":0},rotateZ:{type:"number","default":0},translateX:{type:"number","default":0},translateY:{type:"number","default":0},scaleX:{type:"number","default":100},scaleY:{type:"number","default":100},skewX:{type:"number",required:!1,"default":0},skewY:{type:"number",required:!1,"default":0},type:["string",!0,"default"],zIndex:["number",!0,0]}});b.exports=e},{"./../mappable/state":11}],6:[function(a,b,c){"use strict";var d=a("./../state");b.exports=d.SVG=d.extend({props:{src:["string",!0,null]},initialize:function(){if(d.prototype.initialize.apply(this,arguments),!this.src)throw new Error("Missing src attribute for SVG layer")}})},{"./../state":5}],7:[function(a,b,c){"use strict";var d=a("./../view");b.exports=d.SVG=d.extend({autoRender:!0,template:function(){return'<div class="layer-svg" layer-id="'+this.model.cid+'" view-id="'+this.cid+'"></div>'},bindings:VFDeps.assign({width:{name:"width",type:"attribute"},height:{name:"height",type:"attribute"}},d.prototype.bindings),extractStyles:function(){var a=this.cid,b=document.getElementById(this.cid);return this.queryAll("[style]").forEach(function(c){var d=c.getAttribute("style");console.info("svg element %s with style",c.id,d.length),c.id&&(b.innerHTML+="\n/* "+c.id+' */\n [view-id="'+a+'"] #'+c.id+" {\n"+d+"\n}",c.removeAttribute("style"))}),this},loadSVG:function(){var a=this,b=a.model.src,c=a.el;b&&c&&fetch(b).then(function(a){return a.text()}).then(function(d){c.innerHTML=d,console.info("fetched %s",b,d.length),a.extractStyles()})},initialize:function(){d.prototype.initialize.apply(this,arguments),this.on("change:rendered",this.loadSVG),this.listenToAndRun(this.model,"change:src",this.loadSVG)},remove:function(){var a=document.getElementById(this.cid);console.info("remove svg style element",a),a.parentNode.removeChild(a),d.prototype.remove.apply(this,arguments)},render:function(){if(this.el)return this;var a=document.createElement("style");return a.id=this.cid,document.head.appendChild(a),this.renderWithTemplate(),this}})},{"./../view":10}],8:[function(a,b,c){"use strict";var d=a("./../state");b.exports=d.video=d.extend({props:{src:["string",!0,null]},initialize:function(){if(d.prototype.initialize.apply(this,arguments),!this.src)throw new Error("Missing src attribute for video layer")}})},{"./../state":5}],9:[function(a,b,c){"use strict";var d=a("./../view");b.exports=d.video=d.extend({template:"<video autoplay loop muted></video>",bindings:VFDeps.assign({width:{name:"width",type:"attribute"},height:{name:"height",type:"attribute"},"model.src":{type:"attribute",name:"src"}},d.prototype.bindings)})},{"./../view":10}],10:[function(a,b,c){"use strict";var d=window.VFDeps.View,e=d.extend({template:function(){return'<div class="missing-layer-view" style="will-change:transform, opacity, backfaceVisibility;width:100%;height:100%;display:table"><div style="display:table-cell;color:#a66;vertical-align:middle;text-align:center;font-weight:700;font-size:30px;text-shadow:0 0 4px #000">Missing <span data-hook="type"></span> for <span data-hook="name"></span> layer view<br/><span data-hook="frametime"></span> </div></div>'},derived:{style:{deps:["width","height","model.opacity","model.skewX","model.skewY","model.rotateX","model.rotateY","model.rotateZ","model.translateX","model.translateY","model.scaleX","model.scaleY","model.originX","model.originY","model.backfaceVisibility","model.mixBlendMode","model.zIndex"],fn:function(){return{opacity:.01*this.model.opacity,mixBlendMode:this.model.mixBlendMode,width:this.width+"px",height:this.height+"px",zIndex:this.zIndex||0,perspective:this.model.perspective+"px",transform:"rotateX("+this.model.rotateX+"deg) rotateY("+this.model.rotateY+"deg) rotateZ("+this.model.rotateZ+"deg) translateX("+this.model.translateX+"%) translateY("+this.model.translateY+"%) scaleX("+.01*this.model.scaleX+") scaleY("+.01*this.model.scaleY+") skewX("+this.model.skewX+"deg) skewY("+this.model.skewY+"deg) "}}}},session:{width:["number",!0,400],height:["number",!0,300]},bindings:{"model.active":{type:"toggle"},"model.type":"[data-hook=type]","model.name":"[data-hook=name]",style:{type:function(){var a=this.style,b=this.el.style;Object.keys(a).forEach(function(c){b[c]=a[c]})}}},update:function(){}});b.exports=e},{}],11:[function(a,b,c){"use strict";var d=VFDeps.State,e=VFDeps.Collection,f={};f.toggleProp=function(a,b,c){return!c[b.targetProperty]};var g=d.extend({id:"targetProperty",props:{type:["string",!1,null],value:["any",!1,null],eventNames:["string",!0,""],targetProperty:["string",!0,""]},derived:{targetModel:{deps:["collection","collection.parent"],fn:function(){return this.collection.parent}},observedModel:{deps:["targetModel","targetModel.collection","targetModel.collection.parent"],fn:function(){return this.targetModel.collection.parent}},definition:{deps:["targetProperty","targetModel"],fn:function(){return this.targetModel.constructor.prototype._definition[this.targetProperty]}}},applyValue:function(a){var b=a;"undefined"!=typeof this.value&&null!==this.value&&(b=this.value);var c=this.type;"string"==typeof c&&(c=f[c]),"function"==typeof c&&(b=c(a,this,this.targetModel)),this.targetModel.set(this.targetProperty,b)},delegateMappingEvents:function(){var a=this.previousAttributes().eventNames;a&&this.stopListening(this.observedModel,a),this.eventNames&&this.observedModel&&this.listenTo(this.observedModel,this.eventNames,this.applyValue)},initialize:function(){this.delegateMappingEvents(),this.on("change:eventNames",this.delegateMappingEvents)}}),h=e.extend({mainIndex:"targetProperty",comparator:"targetProperty",model:function(a,b){var c=new g(a,b);return b.init===!1&&c.initialize(),c},serialize:function(){return this.map(function(a){return a.serialize()})}}),i=d.extend({initialize:function(){this.fillCollection()},fillCollection:function(){var a=this.mappings,b=Object.keys(this.constructor.prototype._definition).filter(function(a){return["type","name"].indexOf(a)<0});return b.forEach(function(b){a.get(b)||a.add({targetProperty:b})}),this},derived:{propDefaults:{fn:function(){var a,b={},c=this.constructor.prototype._definition;for(a in c)b[a]=c[a]["default"];return b}}},serialize:function(a){a=a||{};var b,c=d.prototype.serialize.call(this,a),e=this.propDefaults,f={};for(b in c)"mappings"===b||"undefined"!=typeof e[b]&&c[b]===e[b]||(f[b]=c[b]);return a.mappings&&(f.mappings=c.mappings),c},collections:{mappings:h}});i.State=g,i.Collection=h,b.exports=i},{}],12:[function(a,b,c){"use strict";function d(){h.resize(g)}var e=a("./screen/state"),f=a("./screen/view"),g=document.body,h=new f({model:new e({}),broadcastId:window.location.hash.slice(1)||"vfBus",el:document.querySelector(".screen"),width:g.clientWidth,height:g.clientHeight});h.render(),window.addEventListener("resize",VFDeps.debounce(d,100)),setTimeout(d,1500)},{"./screen/state":13,"./screen/view":14}],13:[function(a,b,c){"use strict";var d=VFDeps.State,e=VFDeps.Collection,f=a("./../layer/state");a("./../layer/canvas/state"),a("./../layer/video/state"),a("./../layer/svg/state"),a("./../layer/img/state");var g=a("./../signal/state");a("./../signal/beat/state"),a("./../signal/hsla/state"),a("./../signal/rgba/state");var h=d.extend({initialize:function(){this.on("change:frametime",function(){this.trigger("frametime",this.frametime)})},props:{audioMinDb:["number",!0,-90],audioMaxDb:["number",!0,-10],audioSmoothing:["number",!0,.85],audioFftSize:["number",!0,256],frametime:["number",!0,0],firstframetime:["any",!0,function(){return performance.now()}],signals:["object",!0,function(){return{}}]},collections:{screenLayers:e.extend({comparator:"zIndex",mainIndex:"name",model:function(a,b){var c=f[a.type]||f;return new c(a,b)}}),screenSignals:e.extend({mainIndex:"name",model:function(a,b){var c=g[a.type]||g;return new c(a,b)}})},session:{latency:["number",!0,0]}});b.exports=h},{"./../layer/canvas/state":1,"./../layer/img/state":3,"./../layer/state":5,"./../layer/svg/state":6,"./../layer/video/state":8,"./../signal/beat/state":15,"./../signal/hsla/state":16,"./../signal/rgba/state":17,"./../signal/state":18}],14:[function(a,b,c){"use strict";var d=window.VFDeps.View,e=a("./../layer/view");a("./../layer/canvas/view"),a("./../layer/svg/view"),a("./../layer/video/view"),a("./../layer/img/view");var f=d.extend({autoRender:!0,template:'<div class="screen"></div>',derived:{inactive:{deps:["mode","controlScreenDeactivated"],fn:function(){return"control"===this.mode&&this.controlScreenDeactivated}},signalNames:{deps:["screenSignals","MIDIAccess"],fn:function(){var a=[];if(this.audioAnalyser)for(var b=0;b<this.audioAnalyser.frequencyBinCount;b++)a.push("mic:"+b);var c=this.model.screenSignals.map(function(a){return a.name}).concat(this.MIDIAccess?this.MIDIAccess.signalNames:[],a);return c}}},session:{controlScreenDeactivated:["boolean",!0,!1],width:["number",!0,400],height:["number",!0,300],broadcastId:["string",!0,"vfBus"],ratio:{type:"number",required:!0,"default":4/3,values:[0,4/3,16/9]},MIDIAccess:"state",captureMouse:["boolean",!0,!1],captureDebug:["boolean",!0,!1],mode:{type:"string",required:!0,"default":"screen",values:["screen","control"]}},bindings:{inactive:{type:"toggle",invert:!0}},execCommand:function(a,b,c){this.inactive||(b.latency=performance.now()-c,this.update(b))},initialize:function(){var a=this;if(!a.model)throw new Error("Missing model option for ScreenView");if(window.BroadcastChannel){var b=a.channel=new window.BroadcastChannel(this.broadcastId);b.onmessage=function(b){a.execCommand(b.data.type,b.data.data,b.timeStamp)}}},remove:function(){return this.channel&&this.channel.close(),d.prototype.remove.apply(this,arguments)},resize:function(a){if(!this.el)return this;if("screen"===this.mode)return this.el.style.position="fixed",this.el.top=0,this.el.left=0,this.el.style.width="100%",this.el.style.height="100%",this.width=this.el.clientWidth,this.height=this.el.clientHeight,this.resizeLayers();if(a=a||this.el.parentNode,a&&a.clientWidth){this.width=a.clientWidth;var b=this.ratio||4/3;this.height=Math.floor(this.width/b),this.el.style.width=this.width+"px",this.el.style.height=this.height+"px"}return this.resizeLayers()},resizeLayers:function(){if(!this.layersView||!this.layersView.views)return this;var a=this.width,b=this.height;return this.layersView.views.forEach(function(c){c.width=a,c.height=b}),this},render:function(){return this.renderWithTemplate(),this.layersView=this.renderCollection(this.model.screenLayers,function(a){var b=a.model.getType(),c=e[b]||e;return new c(a)},this.el,{parent:this}),this.resize()},update:function(a){function b(a){return function(b){return b.name===a}}if(!this.layersView)return this.render().update(a);this.model.set(a);var c,d=this.model.screenLayers;return a.screenLayers&&(a.screenLayers.forEach(function(a){c=!0;var b=d.get(a.name);b?b.set(a,{silent:!0}):d.add(a,{silent:!0})}),d.forEach(function(e){var f=a.screenLayers.find(b(e.name));f||(c=!0,d.remove(e,{silent:!0}))}),c&&this.trigger("change:screenLayers",d)),this.layersView.views.forEach(function(a){a.update()}),this}});b.exports=f},{"./../layer/canvas/view":2,"./../layer/img/view":4,"./../layer/svg/view":7,"./../layer/video/view":9,"./../layer/view":10}],15:[function(a,b,c){"use strict";var d=a("./../state"),e=d.beatSignal=d.extend({initialize:function(){d.prototype.initialize.apply(this,arguments);var a=this;this.collection.parent.on("change:frametime",function(b,c){a._ft=c})},session:{_ft:["number",!0,0]},derived:{result:{deps:["timeBetweenBeats","_ft"],fn:function(){return this.computeSignal()}},timeBetweenBeats:{deps:["input"],fn:function(){return 6e4/Math.max(this.input,1)}}},computeSignal:function(){var a=this._ft,b=a?100-a%this.timeBetweenBeats/this.timeBetweenBeats*100:0,c=d.prototype.computeSignal.apply(this,[b]);return c}});b.exports=e},{"./../state":18}],16:[function(a,b,c){"use strict";var d=a("./../state"),e={type:"number",required:!0,"default":180,min:0,max:360},f={type:"number",required:!0,"default":100,min:0,max:100},g=d.hslaSignal=d.extend({session:{hue:e,saturation:f,lightness:f,alpha:f},derived:{result:{deps:["hue","saturation","lightness","alpha"],fn:function(){return this.computeSignal()}}},computeSignal:function(){return"hsla("+Math.round(this.hue)+","+Math.round(this.saturation)+"%,"+Math.round(this.lightness)+"%,"+Math.round(this.alpha)/100+")"}});b.exports=g},{"./../state":18}],17:[function(a,b,c){"use strict";var d=a("./../state"),e={type:"number",required:!0,"default":180,min:0,max:255},f={type:"number",required:!0,"default":100,min:0,max:100},g=d.rgbaSignal=d.extend({session:{red:e,green:e,blue:e,alpha:f},derived:{result:{deps:["red","green","blue","alpha"],fn:function(){return this.computeSignal()}}},computeSignal:function(){return"rgba("+Math.round(this.red)+","+Math.round(this.green)+","+Math.round(this.blue)+","+Math.round(this.alpha)/100+")"}});b.exports=g},{"./../state":18}],18:[function(a,b,c){"use strict";var d=window.VFDeps.State,e=window.VFDeps.Collection,f=a("./../mappable/state"),g=a("./../transformation/functions"),h=d.extend({props:{name:["string",!0,null],arguments:["array",!0,function(){return[]}]}}),i=f.extend({idAttribute:"name",typeAttribute:"type",initialize:function(){this.on("change:result",function(){this.collection.parent.trigger(this.name,this.result)}),(null===this.input||void 0===this.input)&&(this.input=this.defaultValue)},props:{name:["string",!0,null],type:["string",!0,"default"],defaultValue:["any",!0,function(){return 1}]},session:{input:["any",!1,null]},collections:{transformations:e.extend({model:h})},derived:{result:{deps:["input","transformations"],fn:function(){return this.computeSignal()}}},computeSignal:function(a){return a=a||this.input,this.transformations.forEach(function(b){var c=[a].concat(b.arguments);a=g[b.name].apply(this,c)}),a}});b.exports=i},{"./../mappable/state":11,"./../transformation/functions":19}],19:[function(a,b,c){"use strict";var d={};d["math.multiply"]=function(a,b){return a*b},d["math.add"]=function(a,b){return a+b},d["math.subtract"]=function(a,b){return a-b},d["math.modulo"]=function(a,b){return a%b},d["math.above"]=function(a,b){return a>b},d["math.aboveOrEqual"]=function(a,b){return a>=b},d["math.below"]=function(a,b){return b>a},d["math.belowOrEqual"]=function(a,b){return b>=a},d["math.within"]=function(a,b,c){return c>=a&&a>=b},Object.getOwnPropertyNames(Math).forEach(function(a){"constructor"!==a&&"function"==typeof Math[a]&&(d["math."+a]=Math[a])});var e="".constructor.prototype;Object.getOwnPropertyNames(e).forEach(function(a){"constructor"!==a&&"function"==typeof e[a]&&(d["string."+a]=function(b){var c=[].slice.apply(arguments).slice(1);e[a].apply(b,c)})}),d["string.toBool"]=function(a){return!(!a||"false"===a||"null"===a)},d["string.toInteger"]=function(a){return parseInt(a,10)},d["string.toFloat"]=function(a){return parseFloat(a)},d["string.toNumber"]=function(a){return Number(a)},b.exports=d},{}]},{},[12]);